---
import { getCollection } from 'astro:content';
import Layout from '../../layouts/Layout.astro';
import TableOfContents from '../../components/TableOfContents.astro';

export async function getStaticPaths() {
  const notes = await getCollection('notes');
  const paths = [];

  for (const entry of notes) {
    // Primary route: full slug (e.g. operating-system/fcfs-first-come-first-serve)
    paths.push({ params: { slug: entry.slug }, props: { entry } });

    // Alias route: filename only (e.g. fcfs-first-come-first-serve)
    // This makes wiki links like [[FCFS (First Come First Serve)]] work
    // because remark-wiki-link generates /notes/fcfs-(first-come-first-serve)
    const filename = entry.slug.split('/').pop();
    if (filename && filename !== entry.slug) {
      // Only add if no other note already claims this short slug
      if (!notes.some(n => n.slug === filename)) {
        paths.push({ params: { slug: filename }, props: { entry } });
      }
    }
  }

  return paths;
}

const { entry } = Astro.props;
const { Content, headings } = await entry.render();

const allCourses = await getCollection('courses');
const rawCourse = entry.data.course || "";
const cleanCourseRef = rawCourse.replace(/\[\[|\]\]|"/g, "").trim();

const matchedCourse = allCourses.find(c => 
  c.data.title === cleanCourseRef || c.data.code === cleanCourseRef
);

const displayTitle = (() => {
    if (entry.data.title) return entry.data.title;
    const filename = entry.slug.split('/').pop();
    const cleanRaw = filename.replace(/source-|concept-|atom-|lecture-/g, "");
    return cleanRaw.split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
})();

const theme = {
  source: "bg-purple-100 text-purple-800 border-purple-200",
  atom: "bg-blue-100 text-blue-800 border-blue-200", 
  default: "bg-stone-100 text-stone-700 border-stone-200"
};
const currentTheme = theme[entry.data.type] || theme.default;
---

<Layout title={displayTitle}>
  <main class="max-w-5xl mx-auto px-6 py-16">
    <nav class="flex items-center gap-2 text-sm text-stone-400 mb-8 font-mono">
      <a href="/notes" class="hover:text-terracotta transition-colors">Library</a>
      <span>/</span>
      {/* 修正后的三元运算符逻辑 */}
      {matchedCourse ? (
        <a href={`/courses/${matchedCourse.slug}`} class="hover:text-terracotta transition-colors">
          {matchedCourse.data.code}
        </a>
      ) : (
        <span>Unsorted</span>
      )}
    </nav>

    <header class="mb-12 border-b border-stone-200 pb-8">
      <div class="flex flex-wrap gap-3 mb-6 items-center">
        <span class={`px-3 py-1 rounded text-[10px] font-bold tracking-wider uppercase border ${currentTheme}`}>
          {entry.data.type || 'NOTE'}
        </span>
      </div>
      <h1 class="text-4xl md:text-5xl font-serif text-stone-900 leading-tight mb-6">{displayTitle}</h1>
    </header>

    <article class="prose prose-stone prose-lg max-w-none font-serif prose-h1:hidden">
      <Content />
    </article>

    <TableOfContents headings={headings} />
  </main>
</Layout>