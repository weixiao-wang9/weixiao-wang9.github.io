---
import { getCollection } from 'astro:content';
import Layout from '../../layouts/Layout.astro';

const allNotes = await getCollection('notes');
const allCourses = await getCollection('courses');

// ç»Ÿè®¡æ¯é—¨è¯¾æœ‰å¤šå°‘ç¬”è®°
const courseStats = new Map();
const cleanName = (str) => str?.replace(/\[\[|\]\]|"/g, "").trim() || "";

allCourses.forEach(c => courseStats.set(c.data.title, 0));

allNotes.forEach(note => {
    const cName = cleanName(note.data.course);
    if (courseStats.has(cName)) {
        courseStats.set(cName, courseStats.get(cName) + 1);
    }
});
---

<Layout title="Library">
  <main class="max-w-6xl mx-auto px-6 py-20">

    <header class="mb-20 text-center">
      <h1 class="font-serif text-6xl text-stone-900 mb-4">Library</h1>
      {/* ğŸ‘‡ åˆ æ‰äº†é‚£è¡Œ Access restrictedï¼Œæ”¹æˆäº†æ›´æ­£å¸¸çš„å‰¯æ ‡é¢˜ */}
      <p class="text-stone-500 font-serif italic">My Knowledge Base & Course Notes</p>
    </header>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
        {allCourses.map(course => (
            // ğŸ‘‡ å…³é”®ï¼šè¿™é‡Œçš„é“¾æ¥æŒ‡å‘ /courses/[slug]
            // ç¡®ä¿ä½ ä¸‹ä¸€æ­¥åˆ›å»ºçš„æ–‡ä»¶æ˜¯åœ¨ src/pages/courses/ ç›®å½•ä¸‹
            <a href={`/courses/${course.slug}`} class="group block bg-stone-50 p-8 rounded-xl hover:bg-white hover:shadow-xl hover:shadow-stone-200/50 hover:-translate-y-1 transition-all duration-300 border border-transparent hover:border-stone-100">
                <div class="flex justify-between items-start mb-8">
                    <span class="font-mono text-xs text-stone-400 border border-stone-200 px-2 py-1 rounded">
                        {course.data.code}
                    </span>
                    <span class="font-mono text-xs text-terracotta opacity-0 group-hover:opacity-100 transition-opacity">
                        OPEN &rarr;
                    </span>
                </div>
                
                <h3 class="font-serif text-2xl text-stone-900 mb-2 group-hover:text-terracotta transition-colors">
                    {course.data.title}
                </h3>
                
                {course.data.instructor && (
                    <p class="text-xs text-stone-400 uppercase tracking-wider mb-6">
                        {course.data.instructor}
                    </p>
                )}

                <div class="border-t border-stone-200 pt-4 flex justify-between items-center">
                    <span class="text-xs text-stone-500 font-mono">
                        {courseStats.get(course.data.title) || 0} Files
                    </span>
                </div>
            </a>
        ))}
    </div>

  </main>
</Layout>